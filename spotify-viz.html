<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Data Story | Mehul Parashar</title>
    
    <!-- D3.js Library -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
        /* --- Variables & Reset (Matched to Portfolio) --- */
        :root {
            --bg-core: #050505;
            --bg-card: #0f0f0f;
            --gold-accent: #D4AF37;
            --text-primary: #F0F0F0;
            --text-secondary: #888888;
            --border-subtle: rgba(212, 175, 55, 0.15);
            --font-serif: 'Playfair Display', serif;
            --font-sans: 'Manrope', sans-serif;
            --spotify: #1DB954;
            --explicit-red: #e91e63;
            --clean-blue: #2196f3;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-core);
            color: var(--text-primary);
            font-family: var(--font-sans);
            line-height: 1.8;
            overflow-x: hidden;
        }

        /* Grain Overlay */
        .grain-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.03'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 9999;
        }

        /* --- Nav --- */
        nav {
            position: fixed; top: 0; width: 100%; z-index: 1000; padding: 20px 0;
            background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .nav-container { display: flex; justify-content: space-between; max-width: 1100px; margin: 0 auto; padding: 0 2rem; align-items: center; }
        .back-btn { color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; transition: 0.3s; }
        .back-btn:hover { color: var(--gold-accent); }
        .logo { font-family: var(--font-serif); color: var(--text-primary); font-size: 1.2rem; }

        /* --- Layout --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 0 2rem; position: relative; z-index: 1; }
        .section-viz { padding: 100px 0; border-bottom: 1px solid rgba(255,255,255,0.05); min-height: 90vh; display: flex; flex-direction: column; justify-content: center; }
        
        h1 { font-family: var(--font-serif); font-size: clamp(3rem, 5vw, 5rem); line-height: 1.1; }
        h2 { font-family: var(--font-serif); font-size: 2.5rem; color: var(--gold-accent); margin-bottom: 20px; }
        p { max-width: 600px; color: var(--text-secondary); font-size: 1.1rem; }

        /* --- D3 Tooltip --- */
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 10px;
            background: rgba(20, 20, 20, 0.9);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.85rem;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* --- Chart Containers --- */
        .chart-container {
            width: 100%;
            height: 600px;
            background: radial-gradient(circle at center, #111 0%, #050505 100%);
            border: 1px solid var(--border-subtle);
            margin-top: 40px;
            position: relative;
            overflow: hidden;
        }
        
        /* Legend Styles */
        .legend { display: flex; gap: 20px; margin-top: 10px; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-secondary); }
        .legend-item { display: flex; align-items: center; gap: 8px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

    </style>
</head>
<body>

    <div class="grain-overlay"></div>

    <nav>
        <div class="nav-container">
            <a href="index.html" class="back-btn">← Back to Portfolio</a>
            <div class="logo">Spotify Analysis</div>
        </div>
    </nav>

    <!-- Intro Hero -->
    <section class="section-viz">
        <div class="container">
            <span style="color: var(--spotify); text-transform: uppercase; letter-spacing: 3px; font-size: 0.9rem;">Data Story 01</span>
            <h1>The Pulse of Music.</h1>
            <p>Using a dataset of modern streaming metrics, we decode the architecture of hits, the impact of censorship, and the fluid evolution of genre.</p>
            <p style="margin-top: 10px; font-size: 0.9rem; opacity: 0.6;">Scroll to explore ↓</p>
        </div>
    </section>

    <!-- VIZ 1: RADIAL HIT ARCHITECTURE -->
    <section class="section-viz">
        <div class="container">
            <h2>1. The Sonic Ripple</h2>
            <p>Analyzing the "Hit Architecture" of the most popular album in the dataset. Each slice represents a track. The length is duration; the opacity is popularity.</p>
            <div id="viz1" class="chart-container"></div>
            <div class="legend">
                <div class="legend-item">Target: <span id="album-name" style="color:white">Loading...</span></div>
            </div>
        </div>
    </section>

    <!-- VIZ 2: EXPLICIT BEESWARM -->
    <section class="section-viz">
        <div class="container">
            <h2>2. The Explicit Divide</h2>
            <p>Does profanity pay? A gravity simulation of tracks plotted by Artist Popularity vs. Release Date. Red circles are explicit; Blue are clean.</p>
            <div class="legend">
                <div class="legend-item"><div class="dot" style="background:var(--explicit-red)"></div> Explicit</div>
                <div class="legend-item"><div class="dot" style="background:var(--clean-blue)"></div> Clean</div>
            </div>
            <div id="viz2" class="chart-container"></div>
        </div>
    </section>

    <!-- VIZ 3: GENRE STREAM -->
    <section class="section-viz" style="border-bottom: none;">
        <div class="container">
            <h2>3. Genre Evolution</h2>
            <p>Tracing the rise and fall of primary genres over time. A streamgraph visualization of the dataset's musical landscape.</p>
            <div id="viz3" class="chart-container"></div>
        </div>
    </section>

    <!-- Tooltip Div -->
    <div id="tooltip" class="tooltip"></div>

    <script>
        // --- CONFIG ---
        const DATA_URL = "./data/spotify_data_clean.csv";
        const width = 1000;
        const height = 600;
        const tooltip = d3.select("#tooltip");

        // Load Data
        d3.csv(DATA_URL).then(data => {
            
            // Pre-process data types
            data.forEach(d => {
                d.track_popularity = +d.track_popularity;
                d.track_duration_min = +d.track_duration_min;
                d.artist_popularity = +d.artist_popularity;
                d.album_release_date = new Date(d.album_release_date);
                d.explicit = (d.explicit === 'TRUE' || d.explicit === true);
                d.year = d.album_release_date.getFullYear();
            });

            console.log("Data Loaded:", data.length, "rows");

            // Render Charts
            drawRadial(data);
            drawBeeswarm(data);
            drawStreamgraph(data);

        }).catch(err => {
            console.error("Error loading data:", err);
            document.querySelector('#viz1').innerHTML = `<p style='color:red; padding:20px;'>Error loading CSV. Ensure 'data/spotify_data_clean.csv' exists in your repo.</p>`;
        });

        // --- 1. RADIAL CHART (Sonic Ripple) ---
        function drawRadial(data) {
            const container = d3.select("#viz1");
            const svg = container.append("svg")
                .attr("viewBox", [-width / 2, -height / 2, width, height])
                .attr("width", "100%")
                .attr("height", "100%");

            // 1. Find the single most popular album (sum of track popularity)
            const albums = d3.rollup(data, v => ({
                totalPop: d3.sum(v, d => d.track_popularity),
                tracks: v.sort((a, b) => a.track_number - b.track_number),
                artist: v[0].artist_name,
                name: v[0].album_name
            }), d => d.album_name);

            // Convert Map to Array and sort by popularity
            const sortedAlbums = Array.from(albums).sort((a, b) => b[1].totalPop - a[1].totalPop);
            const topAlbum = sortedAlbums[0][1]; 

            document.getElementById('album-name').innerText = `${topAlbum.name} by ${topAlbum.artist}`;

            const tracks = topAlbum.tracks;
            const innerRadius = 100;
            const outerRadius = 280;

            // Scales
            const x = d3.scaleBand()
                .range([0, 2 * Math.PI])
                .align(0)
                .domain(tracks.map(d => d.track_name));

            const y = d3.scaleLinear() // Duration mapped to length
                .range([innerRadius, outerRadius])
                .domain([0, d3.max(tracks, d => d.track_duration_min)]);

            const color = d3.scaleLinear() // Popularity mapped to opacity/brightness
                .domain([0, 100])
                .range(["#0f0f0f", "#1DB954"]); // Dark to Spotify Green

            // Draw Arcs
            svg.append("g")
                .selectAll("path")
                .data(tracks)
                .join("path")
                .attr("fill", d => color(d.track_popularity))
                .attr("d", d3.arc()
                    .innerRadius(innerRadius)
                    .outerRadius(d => y(d.track_duration_min))
                    .startAngle(d => x(d.track_name))
                    .endAngle(d => x(d.track_name) + x.bandwidth())
                    .padAngle(0.01)
                    .padRadius(innerRadius))
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("fill", "#D4AF37"); // Gold highlight
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.track_name}</strong><br>Pop: ${d.track_popularity}<br>Len: ${d.track_duration_min}m`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).attr("fill", color(d.track_popularity));
                    tooltip.style("opacity", 0);
                });

            // Center Text
            svg.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "-0.5em")
                .style("fill", "#fff")
                .style("font-size", "1.2rem")
                .style("font-family", "var(--font-serif)")
                .text("Album View");
        }

        // --- 2. BEESWARM CHART (Explicit Divide) ---
        function drawBeeswarm(data) {
            const container = d3.select("#viz2");
            // Limit data for performance if needed (e.g. top 300 tracks)
            const sample = data.sort((a,b) => b.track_popularity - a.track_popularity).slice(0, 300);

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, width, height])
                .attr("width", "100%")
                .attr("height", "100%");

            // Scales
            const xScale = d3.scaleTime()
                .domain(d3.extent(sample, d => d.album_release_date))
                .range([50, width - 50]);

            const yScale = d3.scaleLinear()
                .domain([0, 100])
                .range([height - 50, 50]);

            // Simulation
            const simulation = d3.forceSimulation(sample)
                .force("x", d3.forceX(d => xScale(d.album_release_date)).strength(1))
                .force("y", d3.forceY(d => yScale(d.artist_popularity)).strength(0.1))
                .force("collide", d3.forceCollide(6)) // Radius + padding
                .stop();

            // Run simulation manually for static render (faster)
            for (let i = 0; i < 120; ++i) simulation.tick();

            // Draw Circles
            svg.selectAll("circle")
                .data(sample)
                .join("circle")
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("r", 5)
                .attr("fill", d => d.explicit ? "var(--explicit-red)" : "var(--clean-blue)")
                .attr("opacity", 0.7)
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1)
                        .html(`<strong>${d.track_name}</strong><br>${d.artist_name}<br>${d.explicit ? "Explicit" : "Clean"}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => tooltip.style("opacity", 0));

            // Add Axis Labels
            svg.append("g").attr("transform", `translate(0,${height - 30})`)
               .call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat("%Y")))
               .select(".domain").remove();
            
            svg.append("text")
               .attr("x", 20)
               .attr("y", 30)
               .attr("fill", "#fff")
               .style("font-size", "0.8rem")
               .text("↑ Artist Popularity");
        }

        // --- 3. STREAMGRAPH (Genre Evolution) ---
        function drawStreamgraph(data) {
            const container = d3.select("#viz3");

            // 1. Process Genre Data: Count occurrences per year
            // Note: 'artist_genres' is a string list, need to split
            const genreCounts = {}; // { year: { genre: count } }
            const allGenres = new Set();

            data.forEach(d => {
                if (!d.year || isNaN(d.year)) return;
                if (!genreCounts[d.year]) genreCounts[d.year] = {};
                
                // Clean and split genres
                let genres = d.artist_genres.replace(/['"\[\]]/g, '').split(',').map(s => s.trim());
                genres.forEach(g => {
                    if (g && g !== 'N/A') {
                        genreCounts[d.year][g] = (genreCounts[d.year][g] || 0) + 1;
                        allGenres.add(g);
                    }
                });
            });

            // Filter Top 5 Genres for cleaner Viz
            const genreTotals = Array.from(allGenres).map(g => {
                let sum = 0;
                for (let y in genreCounts) sum += (genreCounts[y][g] || 0);
                return { genre: g, count: sum };
            }).sort((a,b) => b.count - a.count).slice(0, 6);
            
            const topGenres = genreTotals.map(d => d.genre);

            // Format for D3 Stack
            const years = Object.keys(genreCounts).sort((a,b) => a-b);
            const stackData = years.map(year => {
                const obj = { year: new Date(year, 0, 1) };
                topGenres.forEach(g => {
                    obj[g] = genreCounts[year][g] || 0;
                });
                return obj;
            });

            // D3 Stack
            const series = d3.stack()
                .keys(topGenres)
                .offset(d3.stackOffsetSilhouette) // The "Stream" shape
                .order(d3.stackOrderInsideOut)
                (stackData);

            const svg = container.append("svg")
                .attr("viewBox", [0, 0, width, height])
                .attr("width", "100%")
                .attr("height", "100%");

            const x = d3.scaleTime()
                .domain(d3.extent(stackData, d => d.year))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([
                    d3.min(series, layer => d3.min(layer, d => d[0])),
                    d3.max(series, layer => d3.max(layer, d => d[1]))
                ])
                .range([height - 50, 50]);

            const color = d3.scaleOrdinal()
                .domain(topGenres)
                .range(["#1DB954", "#2196f3", "#9c27b0", "#ff9800", "#e91e63", "#00bcd4"]);

            const area = d3.area()
                .curve(d3.curveBasis) // Smooth curves
                .x(d => x(d.data.year))
                .y0(d => y(d[0]))
                .y1(d => y(d[1]));

            svg.selectAll("path")
                .data(series)
                .join("path")
                .attr("fill", d => color(d.key))
                .attr("d", area)
                .attr("opacity", 0.8)
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("opacity", 1).attr("stroke", "#fff");
                    tooltip.style("opacity", 1)
                        .html(`<strong>Genre: ${d.key}</strong>`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("opacity", 0.8).attr("stroke", "none");
                    tooltip.style("opacity", 0);
                });

            // Add Axis
            svg.append("g")
                .attr("transform", `translate(0,${height - 30})`)
                .call(d3.axisBottom(x).ticks(width / 80).tickSizeOuter(0))
                .select(".domain").remove();
        }

    </script>
</body>
</html>
